<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》 | 张忠振的笔记</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <script charset="utf-8" async="async" src="/js/jquery.min.js"></script>
    <script charset="utf-8" async="async" src="/js/global.js"></script>
    <script charset="utf-8" async="async" src="/js/fingerprint2.min.js"></script>
    <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?0b31b4c146bf7126aed5009e1a4a11c8";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
    <meta name="description" content="包含: Java 基础，Netty，SpringBoot中间件开发...">
    <meta property="og:title" content="面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html">
    <meta name="twitter:title" content="面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》">
    <meta name="twitter:url" content="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="robots" content="all">
    <meta name="author" content="张忠振">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="keywords" content="张忠振的笔记,Java基础, SpringBoot Stater, Netty">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.34a27db0.css" as="style"><link rel="preload" href="/assets/css/styles.css?v=1687185945158" as="style"><link rel="preload" href="/assets/js/cg-styles.js?v=1687185945158" as="script"><link rel="preload" href="/assets/js/cg-app.js?v=1687185945158" as="script"><link rel="preload" href="/assets/js/cg-3.js?v=1687185945158" as="script"><link rel="preload" href="/assets/js/cg-4.js?v=1687185945158" as="script"><link rel="preload" href="/assets/js/cg-49.js?v=1687185945158" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.34a27db0.css"><link rel="stylesheet" href="/assets/css/styles.css?v=1687185945158">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">张忠振的笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/interview/2020-07-28-面经手册 · 开篇《面试官都问我啥》.html" class="nav-link">
  面经手册
</a></li><li class="dropdown-item"><!----> <a href="/md/java/develop-jvm/2019-05-01-用Java实现JVM第一章《命令行工具》.html" class="nav-link">
  用Java实现JVM
</a></li><li class="dropdown-item"><!----> <a href="/md/java/core/2020-01-06-[源码分析]咋嘞？你的IDEA过期了吧！加个Jar包就破解了，为什么？.html" class="nav-link">
  基础技术
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Netty" class="dropdown-title"><span class="title">Netty</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/netty/basics/NIO基础：三大组件.html" class="nav-link">
  Netty基础篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/assembly/middleware/统一白名单组件.html" class="nav-link">
  springboot中间件
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/interview/2020-07-28-面经手册 · 开篇《面试官都问我啥》.html" class="nav-link">
  面经手册
</a></li><li class="dropdown-item"><!----> <a href="/md/java/develop-jvm/2019-05-01-用Java实现JVM第一章《命令行工具》.html" class="nav-link">
  用Java实现JVM
</a></li><li class="dropdown-item"><!----> <a href="/md/java/core/2020-01-06-[源码分析]咋嘞？你的IDEA过期了吧！加个Jar包就破解了，为什么？.html" class="nav-link">
  基础技术
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Netty" class="dropdown-title"><span class="title">Netty</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/netty/basics/NIO基础：三大组件.html" class="nav-link">
  Netty基础篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/assembly/middleware/统一白名单组件.html" class="nav-link">
  springboot中间件
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第 1 章 谈谈面试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/interview/2020-07-28-面经手册 · 开篇《面试官都问我啥》.html" class="sidebar-link">面经手册 · 开篇《面试官都问我啥》</a></li><li><a href="/md/java/interview/2020-07-30-面经手册 · 第1篇《认知自己的技术栈盲区》.html" class="sidebar-link">面经手册 · 第1篇《认知自己的技术栈盲区》</a></li><li><a href="/md/java/interview/2021-03-07-面试现场：小伙伴美团一面的分享和分析[含解答].html" class="sidebar-link">面试现场：小伙伴美团一面的分享和分析(含解答)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第 2 章 数据结构和算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/interview/2020-08-04-面经手册 · 第2篇《数据结构，HashCode为什么使用31作为乘数？》.html" class="sidebar-link">面经手册 · 第2篇《数据结构，HashCode为什么使用31作为乘数？》</a></li><li><a href="/md/java/interview/2020-08-07-面经手册 · 第3篇《HashMap核心知识，扰动函数、负载因子、扩容链表拆分，深度学习》.html" class="sidebar-link">面经手册 · 第3篇《HashMap核心知识，扰动函数、负载因子、扩容链表拆分，深度学习》</a></li><li><a href="/md/java/interview/2020-08-13-面经手册 · 第4篇《HashMap数据插入、查找、删除、遍历，源码分析》.html" class="sidebar-link">面经手册 · 第4篇《HashMap数据插入、查找、删除、遍历，源码分析》</a></li><li><a href="/md/java/interview/2020-08-16-面经手册 · 第5篇《看图说话，讲解2-3平衡树「红黑树的前身」》.html" class="sidebar-link">面经手册 · 第5篇《看图说话，讲解2-3平衡树「红黑树的前身」》</a></li><li><a href="/md/java/interview/2020-08-20-面经手册 · 第6篇《带着面试题学习红黑树操作原理，解析什么时候染色、怎么进行旋转、与2-3树有什么关联》.html" class="sidebar-link">面经手册 · 第6篇《带着面试题学习红黑树操作原理，解析什么时候染色、怎么进行旋转、与2-3树有什么关联》</a></li><li><a href="/md/java/interview/2020-08-27-面经手册 · 第7篇《ArrayList也这么多知识？一个指定位置插入就把谢飞机面晕了！》.html" class="sidebar-link">面经手册 · 第7篇《ArrayList也这么多知识？一个指定位置插入就把谢飞机面晕了！》</a></li><li><a href="/md/java/interview/2020-08-30-面经手册 · 第8篇《LinkedList插入速度比ArrayList快？你确定吗？》.html" class="sidebar-link">面经手册 · 第8篇《LinkedList插入速度比ArrayList快？你确定吗？》</a></li><li><a href="/md/java/interview/2020-09-03-面经手册 · 第9篇《队列是什么？什么是双端队列、延迟对列、阻塞队列，全是知识盲区！》.html" class="sidebar-link">面经手册 · 第9篇《队列是什么？什么是双端队列、延迟对列、阻塞队列，全是知识盲区！》</a></li><li><a href="/md/java/interview/2020-09-10-面经手册 · 第10篇《扫盲java.util.Collections工具包，学习排序、二分、洗牌、旋转算法》.html" class="sidebar-link">面经手册 · 第10篇《扫盲java.util.Collections工具包，学习排序、二分、洗牌、旋转算法》</a></li><li><a href="/md/java/interview/2020-09-17-面经手册 · 第11篇《StringBuilder 比 String 快？空嘴白牙的，证据呢！》.html" class="sidebar-link">面经手册 · 第11篇《StringBuilder 比 String 快？空嘴白牙的，证据呢！》</a></li><li><a href="/md/java/interview/2020-09-23-面经手册 · 第12篇《面试官，ThreadLocal 你要这么问，我就挂了！》.html" class="sidebar-link">面经手册 · 第12篇《面试官，ThreadLocal 你要这么问，我就挂了！》</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第 3 章 并发和锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/interview/2020-10-14-面经手册 · 第13篇《除了JDK、CGLIB，还有3种类代理方式？面试又卡住！》.html" class="sidebar-link">面经手册 · 第13篇《除了JDK、CGLIB，还有3种类代理方式？面试又卡住！》</a></li><li><a href="/md/java/interview/2020-10-21-面经手册 · 第14篇《volatile 怎么实现的内存可见？没有 volatile 一定不可见吗？》.html" class="sidebar-link">面经手册 · 第14篇《volatile 怎么实现的内存可见？没有 volatile 一定不可见吗？》</a></li><li><a href="/md/java/interview/2020-10-28-面经手册 · 第15篇《码农会锁，synchronized 解毒，剖析源码深度分析！》.html" class="sidebar-link">面经手册 · 第15篇《码农会锁，synchronized 解毒，剖析源码深度分析！》</a></li><li><a href="/md/java/interview/2020-11-04-面经手册 · 第16篇《码农会锁，ReentrantLock之公平锁讲解和实现》.html" class="sidebar-link">面经手册 · 第16篇《码农会锁，ReentrantLock之公平锁讲解和实现》</a></li><li><a href="/md/java/interview/2020-11-11-面经手册 · 第17篇《码农会锁，ReentrantLock之AQS原理分析和实践使用》.html" class="sidebar-link">面经手册 · 第17篇《码农会锁，ReentrantLock之AQS原理分析和实践使用》</a></li><li><a href="/md/java/interview/2020-11-18-面经手册 · 第18篇《AQS 共享锁，Semaphore、CountDownLatch，听说数据库连接池可以用到！》.html" class="sidebar-link">面经手册 · 第18篇《AQS 共享锁，Semaphore、CountDownLatch，听说数据库连接池可以用到！》</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第 4 章 多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/interview/2020-11-25-面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》.html" class="active sidebar-link">面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》</a></li><li><a href="/md/java/interview/2020-12-02-面经手册 · 第20篇《Thread 线程，状态转换、方法使用、原理分析》.html" class="sidebar-link">面经手册 · 第20篇《Thread 线程，状态转换、方法使用、原理分析》</a></li><li><a href="/md/java/interview/2020-12-09-面经手册 · 第21篇《手写线程池，对照学习ThreadPoolExecutor线程池实现原理！》.html" class="sidebar-link">面经手册 · 第21篇《手写线程池，对照学习ThreadPoolExecutor线程池实现原理！》</a></li><li><a href="/md/java/interview/2020-12-16-面经手册 · 第22篇《线程池的介绍和使用，以及基于jvmti设计非入侵监控》.html" class="sidebar-link">面经手册 · 第22篇《线程池的介绍和使用，以及基于jvmti设计非入侵监控》</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第 5 章 JVM 虚拟机</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/interview/2020-12-23-面经手册 · 第23篇《JDK、JRE、JVM，是什么关系？》.html" class="sidebar-link">面经手册 · 第23篇《JDK、JRE、JVM，是什么关系？》</a></li><li><a href="/md/java/interview/2020-12-30-面经手册 · 第24篇《为了搞清楚类加载，竟然手撸JVM！》.html" class="sidebar-link">面经手册 · 第24篇《为了搞清楚类加载，竟然手撸JVM！》</a></li><li><a href="/md/java/interview/2021-01-06-面经手册 · 第25篇《JVM内存模型总结，有各版本JDK对比、有元空间OOM监控案例、有Java版虚拟机，综合学习更容易！》.html" class="sidebar-link">面经手册 · 第25篇《JVM内存模型总结，有各版本JDK对比、有元空间OOM监控案例、有Java版虚拟机，综合学习更容易！》</a></li><li><a href="/md/java/interview/2021-01-13-面经手册 · 第26篇《JVM故障处理工具，使用总结》.html" class="sidebar-link">面经手册 · 第26篇《JVM故障处理工具，使用总结》</a></li><li><a href="/md/java/interview/2021-01-20-面经手册 · 第27篇《JVM 判断对象已死，实践验证GC回收》.html" class="sidebar-link">面经手册 · 第27篇《JVM 判断对象已死，实践验证GC回收》</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第 6 章 Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/interview/2021-03-30-面经手册 · 第28篇《你说，怎么把Bean塞到Spring容器》.html" class="sidebar-link">面经手册 · 第28篇《你说，怎么把Bean塞到Spring容器？》</a></li><li><a href="/md/java/interview/2021-04-07-面经手册 · 第29篇《Spring IOC 特性有哪些，不会读不懂源码！》.html" class="sidebar-link">面经手册 · 第29篇《Spring IOC 特性有哪些，不会读不懂源码！》</a></li><li><a href="/md/java/interview/2021-04-18-面经手册 · 第30篇《关于 Spring 中 getBean 的全流程源码解析》.html" class="sidebar-link">面经手册 · 第30篇《关于 Spring 中 getBean 的全流程源码解析》</a></li><li><a href="/md/java/interview/2021-05-05-面经手册 · 第31篇《Spring Bean IOC、AOP 循环依赖解读》.html" class="sidebar-link">面经手册 · 第31篇《Spring Bean IOC、AOP 循环依赖解读》</a></li></ul></section></li></ul> </aside> <div><main class="page"> <div class="theme-default-content content__default"><h1 id="面经手册-·-第19篇《thread-start-它是怎么让线程启动的呢-》"><a href="#面经手册-·-第19篇《thread-start-它是怎么让线程启动的呢-》" class="header-anchor">#</a> 面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》</h1> <p>作者：小傅哥
<br>博客：<a href="https://bugstack.cn" target="_blank" rel="noopener noreferrer">https://bugstack.cn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>沉淀、分享、成长，让自己和他人都能有所收获！😄</p></blockquote> <h2 id="一、前言"><a href="#一、前言" class="header-anchor">#</a> 一、前言</h2> <p><code>有句话：正因为你优秀，所以难以卓越！</code></p> <p>刚开始听这句话还在上学，既不卓越、也不优秀，甚至可能还有点笨！但突然从某次爬到班级的前几名后，开始喜欢上了这种感觉，原来前面的风景是如此灿烂😜！</p> <p>优秀和卓越差的不是一个等级，当你感觉自己优秀后，还能保持空瓶的心态开始，才能逐步的像卓越迈进，并漫漫长！</p> <p>是不小时候更容易学会更多的知识，但越大越笨了！人可能很容易被自己的年纪大了，当成长者。却很少能保持一个低姿态谦卑的心态，不断的学习。<code>所以最后</code>，放不下自己，也拾不起能力。</p> <p>喜欢一句话，<code>蓝是天的颜色、红是火的象征，我不学大海抄袭天的蓝、也不学晚霞模拟火的红。我就是我，生命是我的、命运是我的</code>。<strong>健身也是你的、学习也是你的</strong>，只要你有一个好心态，自然会走到前面卓越那里！</p> <h2 id="二、面试题"><a href="#二、面试题" class="header-anchor">#</a> 二、面试题</h2> <p><code>谢飞机，小记！</code> <em>码德</em>，年轻人写代码好猖狂，不遵守规范还喷我，你要<code>耗子尾汁</code>！谢飞机骂骂咧咧的下班后，找面试官聊心得。</p> <p><strong>谢飞机</strong>：我感觉天天就像活在粪堆，代码都是乱糟糟，我有心无力！</p> <p><strong>面试官</strong>：怎么，想跳槽了？</p> <p><strong>谢飞机</strong>：想去写代码有规范的公司，想提升！</p> <p><strong>面试官</strong>：嗯！确实，有些大公司的代码质量要好一些。但是你也要自身能力强的。</p> <p><strong>谢飞机</strong>：是的，我一直在努力学习！准备跑路！</p> <p><strong>面试官</strong>：那我顺便考你个题，看看你进大厂的几率大不。<code>嗯... Java 线程如何启动的？</code></p> <p><strong>谢飞机</strong>：如何启动的？<code>start</code> 启动的！</p> <p><strong>面试官</strong>：还有吗？</p> <p><strong>谢飞机</strong>：嗯...，没了！</p> <p><strong>面试官</strong>：嗯，可能<code>会与不会</code>这一个题并不会让你代码有多牛、有多好，但是你的技术栈深度和广度，决定你的编程职业生涯是否有一条康庄大道。还是要多努力！</p> <h2 id="三、线程启动分析"><a href="#三、线程启动分析" class="header-anchor">#</a> 三、线程启动分析</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>咳咳</strong>，Java 的线程创建和启动非常简单，但如果问<code>一个线程是怎么启动起来的</code>往往并不清楚，甚至不知道为什么启动时是<code>调用start()</code>，而不是<code>调用run()</code>方法呢？</p> <p><strong>那么</strong>，为了让大家有一个更直观的认知，我们先站在上帝视角。把这段 Java 的线程代码，到 JDK 方法使用，以及 JVM 的相应处理过程，展示给大家，以方便我们后续逐步分析。</p> <p><img alt="图 19-1 线程启动分析" data-src="https://bugstack.cn/assets/images/2020/interview/interview-19-1.png" loading="lazy" class="lazy"></p> <p><strong>以上</strong>，就是一个线程启动的整体过程分析，会涉及到如下知识点：</p> <ul><li>线程的启动会涉及到本地方法（JNI）的调用，也就是那部分 C++ 编写的代码。</li> <li>JVM 的实现中会有不同操作系统对线程的统一处理，比如：Win、Linux、Unix。</li> <li>线程的启动会涉及到线程的生命周期状态（RUNNABLE），以及唤醒操作，所以最终会有回调操作。<em>也就是调用我们的 run() 方法</em></li></ul> <p>接下来，我们就开始逐步分析每一步源码的执行内容，从而了解线程启动过程。</p> <h2 id="四、线程启动过程"><a href="#四、线程启动过程" class="header-anchor">#</a> 四、线程启动过程</h2> <h3 id="_1-thread-start-uml-图"><a href="#_1-thread-start-uml-图" class="header-anchor">#</a> 1. Thread start UML 图</h3> <p><img alt="图 19-2 Thread start UML 图" data-src="https://bugstack.cn/assets/images/2020/interview/interview-19-2.png" loading="lazy" class="lazy"></p> <p>如图 19-2 是线程的启动过程时序图，整体的链路较长，会涉及到 JVM 的操作。核心源码如下：</p> <ol><li><code>Thread.c</code>：<a href="https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c" target="_blank" rel="noopener noreferrer">https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>jvm.cpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>thread.cpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>os.cpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>os_linux.cpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>os_windows.cpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>vmSymbols.hpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h3 id="_2-java-层面-thread-启动"><a href="#_2-java-层面-thread-启动" class="header-anchor">#</a> 2. Java 层面 Thread 启动</h3> <h4 id="_2-1-start-方法"><a href="#_2-1-start-方法" class="header-anchor">#</a> 2.1 start() 方法</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// JDK 源码</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    group<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>started<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                group<span class="token punctuation">.</span><span class="token function">threadStartFailed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>线程启动方法 <code>start()</code>，在它的方法英文注释中已经把核心内容描述出来。<code>Causes this thread to begin execution; the Java Virtual Machine calls the run method of this thread.</code> 这段话的意思是：由 JVM 调用此线程的 run 方法，使线程开始执行。<em>其实这就是一个 JVM 的回调过程，下文源码分析中会讲到</em></li> <li>另外 <code>start()</code> 是一个 <code>synchronized</code> 方法，但为了避免多次调用，在方法中会由线程状态判断。<code>threadStatus != 0</code>。</li> <li><code>group.add(this)</code>，是把当前线程加入到线程组，ThreadGroup。</li> <li><code>start0()</code>，是一个本地方法，通过 JNI 方式调用执行。这一步的操作才是启动线程的核心步骤。</li></ul> <h4 id="_2-2-start0-本地方法"><a href="#_2-2-start0-本地方法" class="header-anchor">#</a> 2.2 start0() 本地方法</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 本地方法 start0</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册本地方法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Make sure registerNatives is the first thing &lt;clinit&gt; does. */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><code>start0()</code>，是一个本地方法，用于启动线程。</li> <li><code>registerNatives()</code>，这个方法是用于注册线程执行过程中需要的一些本地方法，比如：<code>start0</code>、<code>isAlive</code>、<code>yield</code>、<code>sleep</code>、<code>interrupt0</code>等。</li></ul> <p><strong>registerNatives</strong>，本地方法定义在 <code>Thread.c</code> 中，以下是定义的核心源码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">JNINativeMethod</span> methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token string">&quot;start0&quot;</span><span class="token punctuation">,</span>           <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_StartThread</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;stop0&quot;</span><span class="token punctuation">,</span>            <span class="token string">&quot;(&quot;</span> <span class="token constant">OBJ</span> <span class="token string">&quot;)V&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_StopThread</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;isAlive&quot;</span><span class="token punctuation">,</span>          <span class="token string">&quot;()Z&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_IsThreadAlive</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;suspend0&quot;</span><span class="token punctuation">,</span>         <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_SuspendThread</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;resume0&quot;</span><span class="token punctuation">,</span>          <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_ResumeThread</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;setPriority0&quot;</span><span class="token punctuation">,</span>     <span class="token string">&quot;(I)V&quot;</span><span class="token punctuation">,</span>       <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_SetThreadPriority</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;yield&quot;</span><span class="token punctuation">,</span>            <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_Yield</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;sleep&quot;</span><span class="token punctuation">,</span>            <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>       <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_Sleep</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;currentThread&quot;</span><span class="token punctuation">,</span>    <span class="token string">&quot;()&quot;</span> <span class="token constant">THD</span><span class="token punctuation">,</span>     <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_CurrentThread</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;interrupt0&quot;</span><span class="token punctuation">,</span>       <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_Interrupt</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;holdsLock&quot;</span><span class="token punctuation">,</span>        <span class="token string">&quot;(&quot;</span> <span class="token constant">OBJ</span> <span class="token string">&quot;)Z&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_HoldsLock</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;getThreads&quot;</span><span class="token punctuation">,</span>        <span class="token string">&quot;()[&quot;</span> <span class="token constant">THD</span><span class="token punctuation">,</span>   <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_GetAllThreads</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;dumpThreads&quot;</span><span class="token punctuation">,</span>      <span class="token string">&quot;([&quot;</span> <span class="token constant">THD</span> <span class="token string">&quot;)[[&quot;</span> <span class="token constant">STE</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_DumpThreads</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;setNativeName&quot;</span><span class="token punctuation">,</span>    <span class="token string">&quot;(&quot;</span> <span class="token constant">STR</span> <span class="token string">&quot;)V&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token class-name">JVM_SetNativeThreadName</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li><strong>源码</strong>：<a href="https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c" target="_blank" rel="noopener noreferrer">https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>从定义中可以看到，<code>start0</code> 方法会执行 <code>&amp;JVM_StartThread</code> 方法，最终由 JVM 层面启动线程。</li></ul> <h3 id="_3-jvm-创建线程"><a href="#_3-jvm-创建线程" class="header-anchor">#</a> 3. JVM 创建线程</h3> <h4 id="_3-1-jvm-startthread"><a href="#_3-1-jvm-startthread" class="header-anchor">#</a> 3.1 JVM_StartThread</h4> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">JVM_ENTRY</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token class-name">JVM_StartThread</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span><span class="token operator">*</span> env<span class="token punctuation">,</span> jobject jthread<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token class-name">JVMWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;JVM_StartThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JavaThread</span> <span class="token operator">*</span>native_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 创建线程</span>
  native_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_entry<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 启动线程</span>
  <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span>native_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">JVM_END</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>这部分代码比较多，但核心内容主要是<code>创建线程</code>和<code>启动线程</code>，另外 <code>&amp;thread_entry</code> 也是一个方法，如下：</li></ul> <p><strong>thread_entry，线程入口</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">thread_entry</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token constant">TRAPS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">HandleMark</span> <span class="token function">hm</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Handle</span> <span class="token function">obj</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span><span class="token function">threadObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JavaValue</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token constant">T_VOID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JavaCalls</span><span class="token operator">::</span><span class="token function">call_virtual</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span>
                          obj<span class="token punctuation">,</span>
                          <span class="token class-name">KlassHandle</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">,</span> <span class="token class-name">SystemDictionary</span><span class="token operator">::</span><span class="token class-name">Thread_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          vmSymbols<span class="token operator">::</span><span class="token function">run_method_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          vmSymbols<span class="token operator">::</span><span class="token function">void_method_signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>重点</strong>，在创建线程引入这个线程入口的方法时，<code>thread_entry</code> 中包括了 Java 的回调函数 <code>JavaCalls::call_virtual</code>。这个回调函数会由 JVM 调用。</p> <p><strong>vmSymbols::run_method_name()</strong>，就是那个被回调的方法，源码如下：</p> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>#define <span class="token function">VM_SYMBOLS_DO</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> do_alias<span class="token punctuation">)</span>
<span class="token function">template</span><span class="token punctuation">(</span>run_method_name<span class="token punctuation">,</span> <span class="token string">&quot;run&quot;</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>这个 <code>run</code> 就是我们的 Java 程序中会被调用的 run 方法。接下来我们继续按照代码执行链路，寻找到这个被回调的方法在什么时候调用的。</li></ul> <h4 id="_3-2-javathread"><a href="#_3-2-javathread" class="header-anchor">#</a> 3.2 JavaThread</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>native_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_entry<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来，我们继续看 <code>JavaThread</code> 的源码执行内容。</p> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">JavaThread</span><span class="token operator">::</span><span class="token class-name">JavaThread</span><span class="token punctuation">(</span><span class="token class-name">ThreadFunction</span> entry_point<span class="token punctuation">,</span> size_t stack_sz<span class="token punctuation">)</span> <span class="token operator">:</span>
  <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
#<span class="token keyword">if</span> <span class="token constant">INCLUDE_ALL_GCS</span>
  <span class="token punctuation">,</span> <span class="token function">_satb_mark_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_satb_mark_queue_set<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">_dirty_card_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_dirty_card_queue_set<span class="token punctuation">)</span>
#endif <span class="token comment">// INCLUDE_ALL_GCS</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TraceThreadEvents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tty<span class="token operator">-&gt;</span><span class="token function">print_cr</span><span class="token punctuation">(</span><span class="token string">&quot;creating thread %p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _jni_attach_state <span class="token operator">=</span> _not_attaching_via_jni<span class="token punctuation">;</span>
  <span class="token function">set_entry_point</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Create the native thread itself.</span>
  <span class="token comment">// %note runtime_23</span>
  os<span class="token operator">::</span><span class="token class-name">ThreadType</span> thr_type <span class="token operator">=</span> os<span class="token operator">::</span><span class="token function">java_thread</span><span class="token punctuation">;</span>
  thr_type <span class="token operator">=</span> entry_point <span class="token operator">==</span> <span class="token operator">&amp;</span>compiler_thread_entry <span class="token operator">?</span> os<span class="token operator">::</span><span class="token function">compiler_thread</span> <span class="token operator">:</span>os<span class="token operator">::</span><span class="token function">java_thread</span><span class="token punctuation">;</span>
  os<span class="token operator">::</span><span class="token function">create_thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> thr_type<span class="token punctuation">,</span> stack_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ul><li><code>ThreadFunction entry_point</code>，就是我们上面的 <code>thread_entry</code> 方法。</li> <li><code>size_t stack_sz</code>，表示进程中已有的线程个数。</li> <li><strong>这两个参数</strong>，都会传递给 <code>os::create_thread</code> 方法，用于创建线程使用。</li></ul> <h4 id="_3-3-os-create-thread"><a href="#_3-3-os-create-thread" class="header-anchor">#</a> 3.3 os::create_thread</h4> <p><strong>源码</strong>：</p> <ul><li><code>os_linux.cpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>os_windows.cpp</code>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><code>众所周知，JVM 是个啥！</code>，所以它的 OS 服务实现，Liunx 还有 Windows 等，都会实现线程的创建逻辑。<em>这有点像适配器模式</em></p> <p><strong>os_linux -&gt; os::create_thread</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bool os<span class="token operator">::</span><span class="token function">create_thread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token class-name">ThreadType</span> thr_type<span class="token punctuation">,</span> size_t stack_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;caller responsible&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Allocate the OSThread object</span>
  <span class="token class-name">OSThread</span><span class="token operator">*</span> osthread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Initial state is ALLOCATED but not INITIALIZED</span>
  osthread<span class="token operator">-&gt;</span><span class="token function">set_state</span><span class="token punctuation">(</span><span class="token constant">ALLOCATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  pthread_t tid<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> java_start<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><code>osthread-&gt;set_state(ALLOCATED)</code>，初始化已分配的状态，但此时并没有初始化。</li> <li><code>pthread_create</code>，是类Unix操作系统（Unix、Linux、Mac OS X等）的创建线程的函数。</li> <li><code>java_start</code>，重点关注类，是实际创建线程的方法。</li></ul> <h4 id="_3-4-java-start"><a href="#_3-4-java-start" class="header-anchor">#</a> 3.4 java_start</h4> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">java_start</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 线程ID</span>
  <span class="token keyword">int</span> pid <span class="token operator">=</span> os<span class="token operator">::</span><span class="token function">current_process_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置线程</span>
  <span class="token class-name">ThreadLocalStorage</span><span class="token operator">::</span><span class="token function">set_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置线程状态：INITIALIZED 初始化完成</span>
  osthread<span class="token operator">-&gt;</span><span class="token function">set_state</span><span class="token punctuation">(</span><span class="token constant">INITIALIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 唤醒所有线程</span>
  sync<span class="token operator">-&gt;</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// 循环，初始化状态，则一致等待 wait</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>osthread<span class="token operator">-&gt;</span><span class="token function">get_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">INITIALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token operator">::</span><span class="token function">_no_safepoint_check_flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

  <span class="token comment">// 等待唤醒后，执行 run 方法</span>
  thread<span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li>JVM 设置线程状态，INITIALIZED 初始化完成。</li> <li><code>sync-&gt;notify_all()</code>，唤醒所有线程。</li> <li><code>osthread-&gt;get_state() == INITIALIZED</code>，while 循环等待</li> <li><code>thread-&gt;run()</code>，是等待线程唤醒后，也就是状态变更后，才能执行到。<em>这在我们的线程执行UML图中，也有所体现</em></li></ul> <h3 id="_4-jvm-启动线程"><a href="#_4-jvm-启动线程" class="header-anchor">#</a> 4. JVM 启动线程</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">JVM_ENTRY</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token class-name">JVM_StartThread</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span><span class="token operator">*</span> env<span class="token punctuation">,</span> jobject jthread<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token class-name">JVMWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;JVM_StartThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JavaThread</span> <span class="token operator">*</span>native_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 创建线程</span>
  native_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_entry<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 启动线程</span>
  <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span>native_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">JVM_END</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><code>JVM_StartThread</code> 中有两步，创建（<code>new JavaThread</code>）、启动（<code>Thread::start</code>）。创建的过程聊完了，接下来我们聊启动。</li></ul> <h4 id="_4-1-thread-start"><a href="#_4-1-thread-start" class="header-anchor">#</a> 4.1 Thread::start</h4> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">DisableStartThread</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">is_Java_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      java_lang_Thread<span class="token operator">::</span><span class="token function">set_thread_status</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span><span class="token punctuation">)</span>thread<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">threadObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                          java_lang_Thread<span class="token operator">::</span><span class="token constant">RUNNABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不同的 OS 会有不同的启动代码逻辑</span>
    os<span class="token operator">::</span><span class="token function">start_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>如果没有禁用线程 <code>DisableStartThread</code> 并且是 Java 线程 <code>thread-&gt;is_Java_thread()</code>，那么设置线程状态为 <code>RUNNABLE</code>。</li> <li><code>os::start_thread(thread)</code>，调用线程启动方法。<em>不同的 OS 会有不同的启动代码逻辑</em></li></ul> <h4 id="_4-2-os-start-thread-thread"><a href="#_4-2-os-start-thread-thread" class="header-anchor">#</a> 4.2 os::start_thread(thread)</h4> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> os<span class="token operator">::</span><span class="token function">start_thread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// guard suspend/resume</span>
  <span class="token class-name">MutexLockerEx</span> <span class="token function">ml</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token class-name">SR_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token operator">::</span><span class="token function">_no_safepoint_check_flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">OSThread</span><span class="token operator">*</span> osthread <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  osthread<span class="token operator">-&gt;</span><span class="token function">set_state</span><span class="token punctuation">(</span><span class="token constant">RUNNABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pd_start_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><code>osthread-&gt;set_state(RUNNABLE)</code>，设置线程状态 <code>RUNNABLE</code></li> <li><code>pd_start_thread(thread)</code>，启动线程，这个就由各个 OS 实现类，实现各自系统的启动方法了。<em>比如，windows系统和Linux系统的代码是完全不同的。</em></li></ul> <h4 id="_4-3-pd-start-thread-thread"><a href="#_4-3-pd-start-thread-thread" class="header-anchor">#</a> 4.3 pd_start_thread(thread)</h4> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> os<span class="token operator">::</span><span class="token function">pd_start_thread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">OSThread</span> <span class="token operator">*</span> osthread <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span>osthread<span class="token operator">-&gt;</span><span class="token function">get_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">INITIALIZED</span><span class="token punctuation">,</span> <span class="token string">&quot;just checking&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Monitor</span><span class="token operator">*</span> sync_with_child <span class="token operator">=</span> osthread<span class="token operator">-&gt;</span><span class="token function">startThread_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">MutexLockerEx</span> <span class="token function">ml</span><span class="token punctuation">(</span>sync_with_child<span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token operator">::</span><span class="token function">_no_safepoint_check_flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sync_with_child<span class="token operator">-&gt;</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>这部分代码 <code>notify()</code> 最关键，它可以唤醒线程。</li> <li>线程唤醒后，<code>3.4 中的 thread-&gt;run();</code> 就可以继续执行了。</li></ul> <h3 id="_5-jvm-线程回调"><a href="#_5-jvm-线程回调" class="header-anchor">#</a> 5. JVM 线程回调</h3> <h4 id="_5-1-thread-run-javathread-run"><a href="#_5-1-thread-run-javathread-run" class="header-anchor">#</a> 5.1 thread-&gt;run()[JavaThread::run()]</h4> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// The first routine called by a new Java thread</span>
<span class="token keyword">void</span> <span class="token class-name">JavaThread</span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... 初始化线程操作</span>
  
  <span class="token function">thread_main_inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>os_linux.cpp 类中的 java_start 里的 thread-&gt;run()，最终调用的就是 thread.cpp 的 JavaThread::run() 方法。</li> <li>这部分还需要继续往下看，<code>thread_main_inner();</code> 方法。</li></ul> <h4 id="_5-2-thread-main-inner"><a href="#_5-2-thread-main-inner" class="header-anchor">#</a> 5.2 thread_main_inner</h4> <p><strong>源码</strong>：<a href="https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp" target="_blank" rel="noopener noreferrer">https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token class-name">JavaThread</span><span class="token operator">::</span><span class="token function">thread_main_inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">has_pending_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>java_lang_Thread<span class="token operator">::</span><span class="token function">is_stillborn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">threadObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
      <span class="token class-name">ResourceMark</span> <span class="token function">rm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">set_native_thread_name</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_thread_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">HandleMark</span> <span class="token function">hm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">DTRACE_THREAD_PROBE</span><span class="token punctuation">(</span>stop<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  delete <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>这里有你熟悉的设置的线程名称，<code>this-&gt;set_native_thread_name(this-&gt;get_thread_name())</code>。</li> <li><code>this-&gt;entry_point()</code>，实际调用的就是  3.1 中的 thread_entry 方法。</li> <li><code>thread_entry</code>，方法最终会调用到 <code>JavaCalls::call_virtual</code> 里的<code>vmSymbols::run_method_name()</code>。也就是 run() 方法，至此线程启动完成。<em>终于串回来了！</em></li></ul> <h2 id="五、总结"><a href="#五、总结" class="header-anchor">#</a> 五、总结</h2> <ul><li>线程的启动过程涉及到了 JVM 的参与，所以如果没有认真了解过，确实很难从一个本地方法了解的如此透彻。</li> <li>整个源码分析可以结合着代码调用UML时序图进行学习，基本核心过程包括：<code>Java 创建线程和启动</code>、<code>调用本地方法 start0()</code>、<code>JVM 中 JVM_StartThread 的创建和启动</code>、<code>设置线程状态等待被唤醒</code>、<code>根据不同的OS启动线程并唤醒</code>、<code>最后回调 run() 方法启动 Java 线程</code>。</li> <li>有时候可能只是一步很简单的方法，也会有它的深入之处，当真的懂了以后，就不用死记硬背。<em>如果需要获得以上高清大图，可以添加小傅哥微信(<code>fustack</code>)，备注：Thread大图</em></li></ul></div> <footer class="page-edit"><div class="edit-link"><a rel="noopener noreferrer"> aaaa </a></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/md/java/interview/2020-11-18-面经手册 · 第18篇《AQS 共享锁，Semaphore、CountDownLatch，听说数据库连接池可以用到！》.html" class="prev">
          面经手册 · 第18篇《AQS 共享锁，Semaphore、CountDownLatch，听说数据库连接池可以用到！》
        </a></span> <span class="next"><a href="/md/java/interview/2020-12-02-面经手册 · 第20篇《Thread 线程，状态转换、方法使用、原理分析》.html">
          面经手册 · 第20篇《Thread 线程，状态转换、方法使用、原理分析》
        </a>
        →
      </span></p></div> </main></div> <aside class="page-sidebar"> <div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#一、前言" class="toc-sidebar-link">一、前言</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#二、面试题" class="toc-sidebar-link">二、面试题</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#三、线程启动分析" class="toc-sidebar-link">三、线程启动分析</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#四、线程启动过程" class="toc-sidebar-link">四、线程启动过程</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_1-thread-start-uml-图" class="toc-sidebar-link">1. Thread start UML 图</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_2-java-层面-thread-启动" class="toc-sidebar-link">2. Java 层面 Thread 启动</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_3-jvm-创建线程" class="toc-sidebar-link">3. JVM 创建线程</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_4-jvm-启动线程" class="toc-sidebar-link">4. JVM 启动线程</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_5-jvm-线程回调" class="toc-sidebar-link">5. JVM 线程回调</a></li></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#五、总结" class="toc-sidebar-link">五、总结</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box-toc-over"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">面经手册 · 第19篇《Thread.start() ，它是怎么让线程启动的呢？》</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#一、前言" class="toc-sidebar-link">一、前言</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#二、面试题" class="toc-sidebar-link">二、面试题</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#三、线程启动分析" class="toc-sidebar-link">三、线程启动分析</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#四、线程启动过程" class="toc-sidebar-link">四、线程启动过程</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_1-thread-start-uml-图" class="toc-sidebar-link">1. Thread start UML 图</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_2-java-层面-thread-启动" class="toc-sidebar-link">2. Java 层面 Thread 启动</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_3-jvm-创建线程" class="toc-sidebar-link">3. JVM 创建线程</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_4-jvm-启动线程" class="toc-sidebar-link">4. JVM 启动线程</a></li><li class="toc-sidebar-sub-header"><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#_5-jvm-线程回调" class="toc-sidebar-link">5. JVM 线程回调</a></li></ul></li><li><a href="/md/java/interview/2020-11-25-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C%20%C2%B7%20%E7%AC%AC19%E7%AF%87%E3%80%8AThread.start()%20%EF%BC%8C%E5%AE%83%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A9%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%91%A2%EF%BC%9F%E3%80%8B.html#五、总结" class="toc-sidebar-link">五、总结</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><img src="/images/system/github.png" width="28px" class="nozoom"> <span class="show-txt">Github</span></div> <div class="option-box"><img src="/images/system/gitee.png" width="28px" class="nozoom"> <span class="show-txt">Gitee</span></div> <div class="option-box"><img src="/images/system/left.png" width="28px" class="nozoom"> <span class="show-txt">左栏</span></div> <div title="面经手册 · 第18篇《AQS 共享锁，Semaphore、CountDownLatch，听说数据库连接池可以用到！》" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/java/interview/2020-11-18-面经手册 · 第18篇《AQS 共享锁，Semaphore、CountDownLatch，听说数据库连接池可以用到！》.html"><img src="/images/system/prev.png" width="28px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="面经手册 · 第20篇《Thread 线程，状态转换、方法使用、原理分析》" class="option-box" style="padding-left:2px;text-align:center;"><a href="/md/java/interview/2020-12-02-面经手册 · 第20篇《Thread 线程，状态转换、方法使用、原理分析》.html"><img src="/images/system/next.png" width="28px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div>  <!----> </aside></div><div class="global-ui"><LockArticle></LockArticle><PayArticle></PayArticle></div></div>
    <script src="/assets/js/cg-styles.js?v=1687185945158" defer></script><script src="/assets/js/cg-3.js?v=1687185945158" defer></script><script src="/assets/js/cg-4.js?v=1687185945158" defer></script><script src="/assets/js/cg-49.js?v=1687185945158" defer></script><script src="/assets/js/cg-app.js?v=1687185945158" defer></script>
  </body>
</html>

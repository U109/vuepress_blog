## ç»Ÿä¸€ç™½åå•ç»„ä»¶

> è¯¥é¡¹ç›®çš„å­¦ä¹ æ¥æºäºå°å‚…å“¥çš„[çŸ¥è¯†æ˜Ÿçƒ](https://wx.zsxq.com/dweb2/index/group/48411118851818)
>
> ğŸ¤ºğŸ¤ºğŸ¤º è®¤çœŸå­¦ä¹ ã€å½’çº³æ•´ç†

### 1ã€ç›®çš„

æƒ³è¦å¯¹æŸä¸€äº›æ¥å£å®ç°ç™½åå•åŠŸèƒ½ï¼Œé€šè¿‡ç™½åå•çš„è¿›è¡Œæ”¾è¡Œã€‚

ä¾‹å¦‚ï¼š

```java
     * é€šè¿‡ï¼šhttp://localhost:8081/api/queryUserInfo?userId=zzz
     * æ‹¦æˆªï¼šhttp://localhost:8081/api/queryUserInfo?userId=aaa
     
    @DoWhiteList(key = "userId", returnJson = "{\"code\":\"1111\",\"info\":\"éç™½åå•å¯è®¿é—®ç”¨æˆ·æ‹¦æˆªï¼\"}")
    @RequestMapping(path = "/api/queryUserInfo", method = RequestMethod.GET)
    public UserInfo queryUserInfo(@RequestParam String userId) {
        logger.info("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼š{}", userId);
        return new UserInfo(userId, 19);
    }
```

ä¸ºäº†æ›´æ–¹ä¾¿å¿«æ·çš„å®ç°æ­¤åŠŸèƒ½ï¼Œäºæ˜¯é‡‡ç”¨æ³¨è§£å½¢ + åˆ‡é¢æ¥å¼€å‘ç™½åå•ä¸­é—´ä»¶ã€‚



##  2ã€å·¥ç¨‹ç»“æ„

```java
â”€whitelist-spring-boot-starter
â”‚  â”œâ”€src
â”‚  â”‚  â”œâ”€main
â”‚  â”‚  â”‚  â”œâ”€java
â”‚  â”‚  â”‚  â”‚  â””â”€com
â”‚  â”‚  â”‚  â”‚      â””â”€zzz
â”‚  â”‚  â”‚  â”‚          â””â”€whitelist
â”‚  â”‚  â”‚  â”‚              â”‚  DoJoinPoint.java
â”‚  â”‚  â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  â”‚              â”œâ”€annotation
â”‚  â”‚  â”‚  â”‚              â”‚      DoWhiteList.java
â”‚  â”‚  â”‚  â”‚              â”‚
â”‚  â”‚  â”‚  â”‚              â””â”€config
â”‚  â”‚  â”‚  â”‚                      WhiteListAutoConfigure.java
â”‚  â”‚  â”‚  â”‚                      WhiteListProperties.java
```

* DoJoinPoint.java : è´Ÿè´£å¯¹è‡ªå®šä¹‰æ³¨è§£çš„æ–¹æ³•è¿›è¡Œæ‹¦æˆªå’Œé€»è¾‘å¤„ç†ã€‚
* DoWhiteList.java ï¼š è‡ªå®šä¹‰æ³¨è§£ç±»ã€‚
* WhiteListAutoConfigure.java ï¼šå°†priperties.ymlä¸­å¯¹ç™½åå•çš„é…ç½®è¯»å–åˆ°ä¸­é—´ä»¶ä¸­ã€‚
* WhiteListProperties.java ï¼šymlé…ç½®å¯¹åº”çš„å®ä½“ç±»



## 3ã€ä»£ç 

### 1ã€DoWhiteList

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface DoWhiteList {

    String key() default "";

    String returnJson() default "";

}
```

* @Retention : ç”¨äºæŒ‡å®šæ³¨è§£çš„ä¿ç•™ç­–ç•¥ã€‚å®ƒæœ‰ä¸€ä¸ªå‚æ•°`RetentionPolicy`ï¼Œè¡¨ç¤ºæ³¨è§£çš„ä¿ç•™ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¸‰ç§ç­–ç•¥ï¼š
  * `RetentionPolicy.SOURCE`ï¼šæ³¨è§£åªä¿ç•™åœ¨æºä»£ç ä¸­ï¼Œç¼–è¯‘å™¨ä¼šå¿½ç•¥è¯¥æ³¨è§£ã€‚
  * `RetentionPolicy.CLASS`ï¼šæ³¨è§£ä¿ç•™åœ¨ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œä½†åœ¨è¿è¡Œæ—¶ä¸ä¼šè¢«JVMä¿ç•™ã€‚
  * `RetentionPolicy.RUNTIME`ï¼šæ³¨è§£ä¿ç•™åœ¨ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¿ç•™ï¼Œå¯ä»¥é€šè¿‡åå°„æœºåˆ¶è¯»å–æ³¨è§£ä¿¡æ¯ã€‚
* @Target : ç”¨äºæŒ‡å®šæ³¨è§£å¯ä»¥åº”ç”¨äºå“ªäº›å…ƒç´ ä¸Šã€‚å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°è‡ªå®šä¹‰æ³¨è§£ï¼Œä»¥é™åˆ¶æ³¨è§£çš„ä½¿ç”¨èŒƒå›´ã€‚`@Target`æœ‰å¤šä¸ªå–å€¼ï¼Œä¸åŒçš„å–å€¼ä»£è¡¨äº†æ³¨è§£å¯ä»¥åº”ç”¨äºä¸åŒçš„å…ƒç´ ä¸Šï¼ŒåŒ…æ‹¬:
  * `ElementType.TYPE`
  * `ElementType.FIELD`
  * `ElementType.METHOD`
  * `ElementType.PARAMETER`
  * `ElementType.CONSTRUCTOR`
  * `ElementType.LOCAL_VARIABLE`
  * `ElementType.ANNOTATION_TYPE`
  * `ElementType.PACKAGE`

è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªæ³¨è§£`DoWhiteList`ï¼Œå®ƒçš„ä¿ç•™ç­–ç•¥æ˜¯`RetentionPolicy.RUNTIME`ï¼Œè¡¨ç¤ºåœ¨è¿è¡Œæ—¶ä¹Ÿå¯ä»¥é€šè¿‡åå°„è·å–åˆ°è¯¥æ³¨è§£ã€‚åŒæ—¶ï¼Œè¯¥æ³¨è§£åªèƒ½åº”ç”¨äºæ–¹æ³•ä¸Šï¼Œå› ä¸ºå®ƒçš„`@Target`å–å€¼ä¸º`ElementType.METHOD`ã€‚è¯¥æ³¨è§£æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯`key`ï¼Œä¸€ä¸ªæ˜¯`returnJson`ï¼Œé»˜è®¤å€¼éƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚å®šä¹‰æ³¨è§£æ—¶ï¼Œå¯ä»¥é€šè¿‡`@DoWhiteList(key = "xxx", returnJson = "{\"code\": 200}")`çš„æ–¹å¼æ¥ç»™æ³¨è§£å±æ€§èµ‹å€¼ã€‚è¿™ä¸ªæ³¨è§£çš„ä½œç”¨å¯ä»¥æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯æ¥å®šä¹‰ï¼Œä¾‹å¦‚åœ¨æ¥å£æ–¹æ³•ä¸Šæ·»åŠ è¯¥æ³¨è§£ï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•éœ€è¦è¿›è¡Œç™½åå•æ ¡éªŒï¼Œ`key`å±æ€§è¡¨ç¤ºç™½åå•çš„keyï¼Œ`returnJson`å±æ€§è¡¨ç¤ºæ ¡éªŒæœªé€šè¿‡æ—¶è¿”å›çš„JSONæ•°æ®ã€‚

### 2ã€DoJoinPoint

```java
@Aspect
@Component
public class DoJoinPoint {

    private final Logger logger = LoggerFactory.getLogger(DoJoinPoint.class);

    @Resource
    private String whiteListConfig;

    /**
     * å®šä¹‰åˆ‡ç‚¹
     */
    @Pointcut("@annotation(com.zzz.whitelist.annotation.DoWhiteList)")
    public void aopPoint() {
    }

    /**
     * @param jp æ˜¯ Spring AOP ä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒç”¨äºæ§åˆ¶è¢«åˆ‡å…¥æ–¹æ³•çš„æ‰§è¡Œã€‚
     *           åœ¨ @Around æ³¨è§£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ProceedingJoinPoint å‚æ•°æ¥æ§åˆ¶è¢«åˆ‡å…¥æ–¹æ³•çš„æ‰§è¡Œï¼Œ
     *           ä¾‹å¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰è¿›è¡Œä¸€äº›æ“ä½œï¼Œæˆ–è€…åœ¨æ–¹æ³•æ‰§è¡Œåè¿›è¡Œä¸€äº›æ“ä½œï¼Œè¿˜å¯ä»¥ä¿®æ”¹æ–¹æ³•çš„è¿”å›å€¼æˆ–æŠ›å‡ºå¼‚å¸¸ç­‰ã€‚
     */
    @Around("aopPoint()")
    public Object doRouter(ProceedingJoinPoint jp) throws Throwable {
        // è·å–å†…å®¹
        Method method = getMethod(jp);
        DoWhiteList whiteList = method.getAnnotation(DoWhiteList.class);

        // è·å–å­—æ®µå€¼
        String keyValue = getFiledValue(whiteList.key(), jp.getArgs());
        logger.info("middleware whitelist handler methodï¼š{} valueï¼š{}", method.getName(), keyValue);
        if (null == keyValue || "".equals(keyValue)) {
            return jp.proceed();
        }

        String[] split = whiteListConfig.split(",");

        // ç™½åå•è¿‡æ»¤
        for (String str : split) {
            if (keyValue.equals(str)) {
                return jp.proceed();
            }
        }

        // æ‹¦æˆª
        return returnObject(whiteList, method);
    }

    private Method getMethod(JoinPoint jp) throws NoSuchMethodException {
        //è¯¥å¯¹è±¡è¡¨ç¤ºå½“å‰è¿æ¥ç‚¹çš„ç­¾åã€‚åœ¨ Spring AOP ä¸­ï¼Œè¿æ¥ç‚¹æ˜¯åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥æ’å…¥åˆ‡é¢çš„ç‚¹ï¼Œ
        // ä¾‹å¦‚æ–¹æ³•è°ƒç”¨æˆ–å¼‚å¸¸æŠ›å‡ºã€‚Signature æ¥å£æä¾›äº†è·å–è¿æ¥ç‚¹ç­¾åä¿¡æ¯çš„æ–¹æ³•ï¼Œ
        // åŒ…æ‹¬æ–¹æ³•åã€å‚æ•°ã€è¿”å›ç±»å‹ç­‰ã€‚åœ¨åˆ‡é¢ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ JoinPoint.getSignature()
        // è·å–å½“å‰è¿æ¥ç‚¹çš„ç­¾åä¿¡æ¯ï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œå¤„ç†ã€‚
        Signature sig = jp.getSignature();
        MethodSignature methodSignature = (MethodSignature) sig;
        return jp.getTarget().getClass().getMethod(methodSignature.getName(), methodSignature.getParameterTypes());
    }

    // è¿”å›å¯¹è±¡
    private Object returnObject(DoWhiteList whiteList, Method method) throws IllegalAccessException, InstantiationException {
        Class<?> returnType = method.getReturnType();
        String returnJson = whiteList.returnJson();
        if ("".equals(returnJson)) {
            return returnType.newInstance();
        }
        return JSON.parseObject(returnJson, returnType);
    }

    // è·å–å±æ€§å€¼
    private String getFiledValue(String filed, Object[] args) {
        String filedValue = null;
        for (Object arg : args) {
            try {
                if (null == filedValue || "".equals(filedValue)) {
                    filedValue = BeanUtils.getProperty(arg, filed);
                } else {
                    break;
                }
            } catch (Exception e) {
                if (args.length == 1) {
                    return args[0].toString();
                }
            }
        }
        return filedValue;
    }
}
```

* @Aspect ï¼šç”¨äºå®šä¹‰åˆ‡é¢ã€‚
* @Component ï¼šç”¨äºå£°æ˜ä¸€ä¸ªbeançš„æ³¨è§£ï¼Œå®ƒå¯ä»¥è¢«ç”¨åœ¨ä»»ä½•ç±»ä¸Šï¼Œè¡¨ç¤ºè¿™ä¸ªç±»å°†ä¼šè¢«Springå®¹å™¨æ‰€ç®¡ç†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å®¹å™¨è·å–åˆ°è¯¥ç±»çš„å®ä¾‹ã€‚åœ¨ä½¿ç”¨`@Component`æ³¨è§£æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡æŒ‡å®šbeançš„åç§°æ¥è¿›è¡Œå‘½åï¼Œä¾‹å¦‚`@Component("myBean")`ã€‚
* @Pointcut ï¼š ç”¨äºå®šä¹‰åˆ‡ç‚¹çš„æ³¨è§£ã€‚åˆ‡ç‚¹æ˜¯æŒ‡åœ¨åº”ç”¨ç¨‹åºä¸­çš„æŸä¸ªç‰¹å®šä½ç½®ï¼Œæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªåˆ°æŸäº›æ–¹æ³•çš„æ‰§è¡Œï¼Œå¹¶åœ¨è¿™äº›æ–¹æ³•æ‰§è¡Œå‰ã€æ‰§è¡Œåæˆ–è€…åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åšä¸€äº›é¢å¤–çš„å¤„ç†ã€‚
* @Around ï¼šç”¨äºå®šä¹‰ç¯ç»•é€šçŸ¥çš„æ³¨è§£ã€‚ç¯ç»•é€šçŸ¥æ˜¯æŒ‡åœ¨æ–¹æ³•æ‰§è¡Œå‰å’Œæ–¹æ³•æ‰§è¡Œåéƒ½å¯ä»¥æ‰§è¡Œçš„é€šçŸ¥ï¼Œå®ƒå¯ä»¥æ§åˆ¶æ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œç”šè‡³å¯ä»¥å®Œå…¨æ›¿ä»£åŸæœ‰æ–¹æ³•çš„æ‰§è¡Œã€‚åœ¨ä½¿ç”¨`@Around`æ³¨è§£æ—¶ï¼Œéœ€è¦å°†åˆ‡ç‚¹è¡¨è¾¾å¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå¹¶ä¸”éœ€è¦åœ¨æ–¹æ³•ä¸­æ˜¾å¼è°ƒç”¨`ProceedingJoinPoint.proceed()`æ–¹æ³•æ¥æ‰§è¡ŒåŸæœ‰æ–¹æ³•ã€‚

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªä½¿ç”¨Spring AOPå®ç°çš„æ‹¦æˆªå™¨ï¼Œç”¨äºæ‹¦æˆªå¸¦æœ‰`@DoWhiteList`æ³¨è§£çš„æ–¹æ³•ï¼Œå¹¶å¯¹æ–¹æ³•å‚æ•°è¿›è¡Œç™½åå•è¿‡æ»¤ã€‚å…¶ä¸­ï¼Œ`@Aspect`å’Œ`@Component`æ³¨è§£ç”¨äºå£°æ˜è¿™æ˜¯ä¸€ä¸ªåˆ‡é¢ï¼Œå¹¶å°†å…¶æ³¨å†Œä¸ºSpringçš„ä¸€ä¸ªbeanã€‚`@Around`æ³¨è§£çš„å‚æ•°æ˜¯`aopPoint()`ï¼Œè¡¨ç¤ºæ‹¦æˆª`aopPoint()`æ–¹æ³•æ‰€å¯¹åº”çš„æ‰€æœ‰å¸¦æœ‰`@DoWhiteList`æ³¨è§£çš„æ–¹æ³•ã€‚åœ¨`doRouter()`æ–¹æ³•ä¸­ï¼Œé€šè¿‡`ProceedingJoinPoint`å‚æ•°æ§åˆ¶è¢«åˆ‡å…¥æ–¹æ³•çš„æ‰§è¡Œï¼Œå¹¶å¯¹æ–¹æ³•å‚æ•°è¿›è¡Œç™½åå•è¿‡æ»¤ã€‚å¦‚æœå‚æ•°åœ¨ç™½åå•ä¸­ï¼Œåˆ™ç»§ç»­æ‰§è¡Œè¢«æ‹¦æˆªçš„æ–¹æ³•ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰çš„å¯¹è±¡æˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚

### 3ã€WhiteListProperties

```java
@ConfigurationProperties("zzz.whitelist")
public class WhiteListProperties {

    private String users;

    public String getUsers() {
        return users;
    }

    public void setUsers(String users) {
        this.users = users;
    }

}
```

* @ConfigurationProperties ï¼šç”¨äºå°†é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼è‡ªåŠ¨ç»‘å®šåˆ°Javaç±»çš„å±æ€§ä¸Šã€‚é€šè¿‡è¿™ä¸ªæ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å°†é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼æ³¨å…¥åˆ°æˆ‘ä»¬çš„Javaç±»ä¸­ï¼Œé¿å…äº†æ‰‹åŠ¨ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–å±æ€§å€¼çš„ç¹çæ“ä½œã€‚**æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªæ³¨è§£æŒ‡å®šä¸€ä¸ªå‰ç¼€ï¼Œè¿™ä¸ªå‰ç¼€ä¼šä¸é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§åè¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸåå°±ä¼šå°†å¯¹åº”çš„å±æ€§å€¼æ³¨å…¥åˆ°Javaç±»çš„å±æ€§ä¸­ã€‚**

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªJavaç±»ï¼Œä½¿ç”¨äº†`@ConfigurationProperties`æ³¨è§£ï¼Œè¡¨ç¤ºå°†é…ç½®æ–‡ä»¶ä¸­`zzz.whitelist`å‰ç¼€çš„å±æ€§å€¼ç»‘å®šåˆ°è¯¥ç±»çš„å±æ€§ä¸Šã€‚è¯¥ç±»æœ‰ä¸€ä¸ª`users`å±æ€§ï¼Œè¡¨ç¤ºç™½åå•ä¸­çš„ç”¨æˆ·åˆ—è¡¨ã€‚`getUsers()`å’Œ`setUsers()`æ–¹æ³•åˆ†åˆ«ç”¨äºè·å–å’Œè®¾ç½®è¯¥å±æ€§çš„å€¼ã€‚å½“æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†`zzz.whitelist.users`å±æ€§æ—¶ï¼ŒSpringæ¡†æ¶ä¼šè‡ªåŠ¨å°†è¯¥å±æ€§å€¼æ³¨å…¥åˆ°`WhiteListProperties`ç±»çš„`users`å±æ€§ä¸­ã€‚

### 4ã€WhiteListAutoConfigure

```java
@Configuration
@ConditionalOnClass(WhiteListProperties.class)
@EnableConfigurationProperties(WhiteListProperties.class)
public class WhiteListAutoConfigure {

    @Bean("whiteListConfig")
    @ConditionalOnMissingBean
    public String whiteListConfig(WhiteListProperties properties) {
        return properties.getUsers();
    }

}
```

* @Configuration : ç”¨äºå®šä¹‰åº”ç”¨ç¨‹åºä¸­çš„beanï¼Œå¯ä»¥æ›¿ä»£XMLé…ç½®æ–‡ä»¶ã€‚
* @ConditionalOnClass ï¼š è¡¨ç¤ºå½“æŒ‡å®šçš„ç±»å­˜åœ¨äºç±»è·¯å¾„ä¸­æ—¶ï¼Œæ‰ä¼šåˆ›å»ºè¢«æ³¨è§£çš„Beanã€‚è¯¥æ³¨è§£å¯ä»¥ç”¨äºåœ¨ä¸åŒçš„ç¯å¢ƒä¸‹åˆ›å»ºä¸åŒçš„Beanï¼Œæ¯”å¦‚åœ¨Webç¯å¢ƒä¸‹åˆ›å»ºä¸€ä¸ªBeanï¼Œåœ¨éWebç¯å¢ƒä¸‹ä¸åˆ›å»ºè¯¥Beanã€‚`@ConditionalOnClass`æ³¨è§£è¿˜å¯ä»¥ä¸`@ConditionalOnMissingClass`æ³¨è§£é…åˆä½¿ç”¨ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªBeanï¼Œå½“æŒ‡å®šçš„ç±»ä¸å­˜åœ¨æ—¶ã€‚
* @EnableConfigurationProperties ï¼š ç”¨äºå¯ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª`@ConfigurationProperties`æ³¨è§£çš„ç±»ã€‚å½“æˆ‘ä»¬åœ¨Spring Bootåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨`@ConfigurationProperties`æ³¨è§£æ—¶ï¼Œéœ€è¦ä½¿ç”¨`@EnableConfigurationProperties`æ³¨è§£æ¥å¯ç”¨è¯¥æ³¨è§£æ‰€åœ¨çš„ç±»ã€‚è¯¥æ³¨è§£é€šå¸¸ç”¨äºå°†é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼è‡ªåŠ¨ç»‘å®šåˆ°Javaç±»çš„å±æ€§ä¸Šã€‚åœ¨ä½¿ç”¨è¯¥æ³¨è§£æ—¶ï¼Œéœ€è¦å°†éœ€è¦ç»‘å®šå±æ€§çš„ç±»ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œä¾‹å¦‚`@EnableConfigurationProperties(MyProperties.class)`ã€‚è¿™æ ·ï¼ŒSpring Bootå°±ä¼šè‡ªåŠ¨å°†é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼ç»‘å®šåˆ°`MyProperties`ç±»çš„å±æ€§ä¸Šã€‚
* @Beanï¼šç”¨äºåœ¨Springå®¹å™¨ä¸­å®šä¹‰ä¸€ä¸ªbeanã€‚
* @ConditionalOnMissingBean ï¼š ç”¨äºåœ¨æ»¡è¶³æŒ‡å®šæ¡ä»¶æ—¶æ‰æ³¨å†Œä¸€ä¸ªBeanã€‚å…·ä½“æ¥è¯´ï¼Œå½“Springå®¹å™¨ä¸­ä¸å­˜åœ¨æŒ‡å®šç±»å‹çš„Beanæ—¶ï¼Œæ‰ä¼šæ³¨å†Œè¢«æ³¨è§£çš„Beanã€‚

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªSpring Bootçš„è‡ªåŠ¨é…ç½®ç±»ï¼Œç”¨äºè‡ªåŠ¨é…ç½®ä¸€ä¸ªåä¸º`whiteListConfig`çš„Beanã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ä½¿ç”¨äº†`@Configuration`æ³¨è§£ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼›`@ConditionalOnClass(WhiteListProperties.class)`æ³¨è§£è¡¨ç¤ºåªæœ‰å½“`WhiteListProperties`ç±»å­˜åœ¨æ—¶ï¼Œæ‰ä¼šå¯ç”¨è¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼›`@EnableConfigurationProperties(WhiteListProperties.class)`æ³¨è§£è¡¨ç¤ºå°†`WhiteListProperties`ç±»æ³¨å†Œä¸ºä¸€ä¸ªé…ç½®å±æ€§ç±»ï¼Œä½¿å¾—å¯ä»¥é€šè¿‡`@Autowired`æ³¨è§£å°†å…¶æ³¨å…¥åˆ°å…¶ä»–Beanä¸­ï¼›`@Bean("whiteListConfig")`æ³¨è§£è¡¨ç¤ºå°†`whiteListConfig`æ–¹æ³•è¿”å›çš„å¯¹è±¡æ³¨å†Œä¸ºä¸€ä¸ªBeanï¼Œåç§°ä¸º`whiteListConfig`ï¼›`@ConditionalOnMissingBean`æ³¨è§£è¡¨ç¤ºåªæœ‰å½“Springå®¹å™¨ä¸­ä¸å­˜åœ¨åä¸º`whiteListConfig`çš„Beanæ—¶ï¼Œæ‰ä¼šè°ƒç”¨`whiteListConfig`æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶æ³¨å†Œä¸ºBeanã€‚

`whiteListConfig`æ–¹æ³•çš„å‚æ•°ä¸º`WhiteListProperties`ç±»å‹ï¼Œè¡¨ç¤ºå°†è‡ªåŠ¨æ³¨å…¥ä¸€ä¸ªåä¸º`whiteList`çš„é…ç½®å±æ€§å¯¹è±¡ã€‚`whiteListConfig`æ–¹æ³•çš„è¿”å›å€¼ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºå°†`whiteList`å±æ€§ä¸­çš„`users`å±æ€§å€¼ä½œä¸º`whiteListConfig` Beançš„å€¼è¿”å›ã€‚å¦‚æœ`whiteListConfig` Beanå·²ç»å­˜åœ¨äºSpringå®¹å™¨ä¸­ï¼Œåˆ™ä¸ä¼šå†æ¬¡åˆ›å»ºï¼Œç›´æ¥è¿”å›å·²å­˜åœ¨çš„Beanã€‚



## 4ã€éªŒè¯

1ã€åˆ›å»ºä¸€ä¸ªæµ‹è¯•å·¥ç¨‹ï¼Œé€šè¿‡pom.xmlå°†ç™½åå•ä¸­é—´ä»¶å¼•å…¥ã€‚

2ã€åœ¨ymlä¸­é…ç½®ç™½åå•ç”¨æˆ·

```yaml
# ç™½åå•ç”¨æˆ·
zzz:
  whitelist:
    users: zzz
```

3ã€åˆ›å»ºæ¥å£ï¼Œè¿›è¡Œæµ‹è¯•

```java
    @DoWhiteList(key = "userId", returnJson = "{\"code\":\"1111\",\"info\":\"éç™½åå•å¯è®¿é—®ç”¨æˆ·æ‹¦æˆªï¼\"}")
    @RequestMapping(path = "/api/queryUserInfo", method = RequestMethod.GET)
    public UserInfo queryUserInfo(@RequestParam String userId) {
        logger.info("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼š{}", userId);
        return new UserInfo(userId, 19);
    }
```



